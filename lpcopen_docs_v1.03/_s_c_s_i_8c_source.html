<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>LPCOpen Platform: C:/nxp/v1.03/lpcopen_v1.03/lpcopen/applications/LPCUSBlib/lpcusblib_MassStorageDevice/Lib/SCSI.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="driver.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">LPCOpen Platform
   &#160;<span id="projectnumber">v1.03</span>
   </div>
   <div id="projectbrief">LPCOpen Platform for NXP LPC Microcontrollers</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.2 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_s_c_s_i_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">SCSI.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="_s_c_s_i_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/*</span></div>
<div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"> * @brief SCSI command processing routines, for SCSI commands issues by the host</span></div>
<div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment"> * @note</span></div>
<div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment"> * Copyright(C) NXP Semiconductors, 2012</span></div>
<div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"> * Copyright(C) Dean Camera, 2011, 2012</span></div>
<div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment"> * All rights reserved.</span></div>
<div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment"> * @par</span></div>
<div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment"> * Software that is described herein is for illustrative purposes only</span></div>
<div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"> * which provides customers with programming information regarding the</span></div>
<div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment"> * LPC products.  This software is supplied &quot;AS IS&quot; without any warranties of</span></div>
<div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment"> * any kind, and NXP Semiconductors and its licensor disclaim any and</span></div>
<div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment"> * all warranties, express or implied, including all implied warranties of</span></div>
<div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="comment"> * merchantability, fitness for a particular purpose and non-infringement of</span></div>
<div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="comment"> * intellectual property rights.  NXP Semiconductors assumes no responsibility</span></div>
<div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="comment"> * or liability for the use of the software, conveys no license or rights under any</span></div>
<div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment"> * patent, copyright, mask work right, or any other intellectual property rights in</span></div>
<div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="comment"> * or to any products. NXP Semiconductors reserves the right to make changes</span></div>
<div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="comment"> * in the software without notification. NXP Semiconductors also makes no</span></div>
<div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment"> * representation or warranty that such application will be suitable for the</span></div>
<div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment"> * specified use without further testing or modification.</span></div>
<div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="comment"> *</span></div>
<div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="comment"> * @par</span></div>
<div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment"> * Permission to use, copy, modify, and distribute this software and its</span></div>
<div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;<span class="comment"> * documentation is hereby granted, under NXP Semiconductors&#39; and its</span></div>
<div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="comment"> * licensor&#39;s relevant copyrights in the software, without fee, provided that it</span></div>
<div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;<span class="comment"> * is used in conjunction with NXP Semiconductors microcontrollers.  This</span></div>
<div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;<span class="comment"> * copyright, permission, and disclaimer notice must appear in all copies of</span></div>
<div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;<span class="comment"> * this code.</span></div>
<div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;<span class="comment"> */</span></div>
<div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div>
<div class="line"><a name="l00033"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#a7e9cb871d3969af870f73b5cff662b4c">   33</a></span>&#160;<span class="preprocessor">#define  INCLUDE_FROM_SCSI_C</span></div>
<div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;<span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="_s_c_s_i_8h.html">SCSI.h</a>&quot;</span></div>
<div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div>
<div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;<span class="comment"> * Private types/enumerations/variables</span></div>
<div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;<span class="comment"> ****************************************************************************/</span></div>
<div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div>
<div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;<span class="comment"> * Public types/enumerations/variables</span></div>
<div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="comment"> ****************************************************************************/</span></div>
<div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div>
<div class="line"><a name="l00047"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#ae813fbf7ac35aa107d8f3e79fa5a283b">   47</a></span>&#160;<span class="keyword">static</span> <span class="keyword">const</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gae774218b5f41098f22cdeb569f9ed19e">SCSI_Inquiry_Response_t</a> <a class="code" href="_s_c_s_i_8c.html#ae813fbf7ac35aa107d8f3e79fa5a283b">InquiryData</a> = {</div>
<div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160; .DeviceType          = <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89cd973fab7f69a278db6df0dee58f4a">DEVICE_TYPE_BLOCK</a>,</div>
<div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160; .PeripheralQualifier = 0,</div>
<div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div>
<div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160; .Removable           = <span class="keyword">true</span>,</div>
<div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;</div>
<div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160; .Version             = 0,</div>
<div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;</div>
<div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160; .ResponseDataFormat  = 2,</div>
<div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160; .NormACA             = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160; .TrmTsk              = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160; .AERC                = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div>
<div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160; .AdditionalLength    = 0x1F,</div>
<div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div>
<div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160; .SoftReset           = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160; .CmdQue              = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160; .Linked              = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160; .Sync                = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160; .WideBus16Bit        = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160; .WideBus32Bit        = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160; .RelAddr             = <span class="keyword">false</span>,</div>
<div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div>
<div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160; .VendorID            = <span class="stringliteral">&quot;NXP&quot;</span>,</div>
<div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160; .ProductID           = <span class="stringliteral">&quot;Dataflash Disk&quot;</span>,</div>
<div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160; .RevisionID          = {<span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;.&#39;</span>, <span class="charliteral">&#39;0&#39;</span>, <span class="charliteral">&#39;0&#39;</span>},</div>
<div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div>
<div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div>
<div class="line"><a name="l00078"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#aae378701a4160a515783b3a5e21c437e">   78</a></span>&#160;<span class="keyword">static</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga792bd25050191df94093c51707cd1e15">SCSI_Request_Sense_Response_t</a> <a class="code" href="_s_c_s_i_8c.html#aae378701a4160a515783b3a5e21c437e">SenseData</a> = {</div>
<div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160; .ResponseCode        = 0x70,</div>
<div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160; .AdditionalLength    = 0x0A,</div>
<div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;};</div>
<div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div>
<div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;<span class="preprocessor">#ifdef CFG_SDCARD</span></div>
<div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;<span class="preprocessor"></span>uint8_t *disk_cache = (uint8_t *) 0x20000000;</div>
<div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;<span class="keyword">static</span> <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> MSC_Get_Block_Count(<span class="keywordtype">void</span>)</div>
<div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;{</div>
<div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160; <span class="keywordflow">return</span> (<a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a>) <a class="code" href="group___s_d_m_m_c__18_x_x__43_x_x.html#gad6a8510859b4572e2caa914c236dcae0" title="Get the number of device blocks of SD/MMC card (after enumeration) Since Chip_SDMMC_GetDeviceSize is ...">Chip_SDMMC_GetDeviceBlocks</a>(<a class="code" href="group___p_e_r_i_p_h__18_x_x___b_a_s_e.html#ga0dad86ccae5b13170e0204ed651a2847">LPC_SDMMC</a>);</div>
<div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div>
<div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;</div>
<div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;<span class="comment"> * Private functions</span></div>
<div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment"> ****************************************************************************/</span></div>
<div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div>
<div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;<span class="comment">/*****************************************************************************</span></div>
<div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;<span class="comment"> * Public functions</span></div>
<div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;<span class="comment"> ****************************************************************************/</span></div>
<div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div>
<div class="line"><a name="l00105"></a><span class="lineno"><a class="code" href="group___mass___storage___device___s_c_s_i.html#ga3b71f7f089feea74b0e8524c9b79d126">  105</a></span>&#160;<span class="keywordtype">bool</span> <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga3b71f7f089feea74b0e8524c9b79d126" title="Main routine to process the SCSI command located in the Command Block Wrapper read from the host...">SCSI_DecodeSCSICommand</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;{</div>
<div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160; <span class="keywordtype">bool</span> CommandSuccess = <span class="keyword">false</span>;</div>
<div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;</div>
<div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160; <span class="comment">/* Run the appropriate SCSI command hander function based on the passed command */</span></div>
<div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160; <span class="keywordflow">switch</span> (MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[0]) {</div>
<div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gac1f82346efef75cf197abb8e29cc5f44">SCSI_CMD_INQUIRY</a>:</div>
<div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#a0137191ee92c01b7ae7f2b63739b27c7">SCSI_Command_Inquiry</a>(MSInterfaceInfo);</div>
<div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div>
<div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gad0ffafc58d70417e80425b2ee80c1769">SCSI_CMD_REQUEST_SENSE</a>:</div>
<div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#a26123dc4d7ffdd6f60ce7cc9f5b4392f">SCSI_Command_Request_Sense</a>(MSInterfaceInfo);</div>
<div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div>
<div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga1f08c7a277432486b2f875035df6790b">SCSI_CMD_READ_CAPACITY_10</a>:</div>
<div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#a0b33262f1bc3886722196d9a8d87efcb">SCSI_Command_Read_Capacity_10</a>(MSInterfaceInfo);</div>
<div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div>
<div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga193c6674b8dee669a59b2d32035c3c4b">SCSI_CMD_SEND_DIAGNOSTIC</a>:</div>
<div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#adc91b127f1dc8952de57a7cf46bb129f">SCSI_Command_Send_Diagnostic</a>(MSInterfaceInfo);</div>
<div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div>
<div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gad1733ce8730cdaab39b9b868b73128a0">SCSI_CMD_WRITE_10</a>:</div>
<div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#af6f83e66195f7956862be0cd00dca196">SCSI_Command_ReadWrite_10</a>(MSInterfaceInfo, <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga1033012652c8143c410c1b30f1dc5af0">DATA_WRITE</a>);</div>
<div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;</div>
<div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gad3900f141fb70afb8def054384805a2e">SCSI_CMD_READ_10</a>:</div>
<div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#af6f83e66195f7956862be0cd00dca196">SCSI_Command_ReadWrite_10</a>(MSInterfaceInfo, <a class="code" href="group___mass___storage___device___s_c_s_i.html#gab2f24d71b50144885a0f182b6d2e274a">DATA_READ</a>);</div>
<div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div>
<div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gab6164a7d5f81211ce8d98b6a731b4f69">SCSI_CMD_MODE_SENSE_6</a>:</div>
<div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;  CommandSuccess = <a class="code" href="_s_c_s_i_8c.html#a03d4a35fdb5a2b73965af52a4ac59307">SCSI_Command_ModeSense_6</a>(MSInterfaceInfo);</div>
<div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div>
<div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gaa84c8ac327fad55b9d0e40fea9eda699">SCSI_CMD_TEST_UNIT_READY</a>:</div>
<div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#gaaf06eae501781dbc6e41126536ffca3c">SCSI_CMD_PREVENT_ALLOW_MEDIUM_REMOVAL</a>:</div>
<div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160; <span class="keywordflow">case</span> <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga8d3ebefbce899ff775e8fab101f59080">SCSI_CMD_VERIFY_10</a>:</div>
<div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;  <span class="comment">/* These commands should just succeed, no handling required */</span></div>
<div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;  CommandSuccess = <span class="keyword">true</span>;</div>
<div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength = 0;</div>
<div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div>
<div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160; <span class="keywordflow">default</span>:</div>
<div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <span class="comment">/* Update the SENSE key to reflect the invalid command */</span></div>
<div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga9b67f1f2b889dec9c96b56f7f6e0437d">SCSI_SENSE_KEY_ILLEGAL_REQUEST</a>,</div>
<div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga998afa8c8df4c9717f6f7fda10f6f213">SCSI_ASENSE_INVALID_COMMAND</a>,</div>
<div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160; }</div>
<div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div>
<div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160; <span class="comment">/* Check if command was successfully processed */</span></div>
<div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160; <span class="keywordflow">if</span> (CommandSuccess) {</div>
<div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga0c7ac995f792ba2a3376afad3ebfed80">SCSI_SENSE_KEY_GOOD</a>,</div>
<div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga1befdc28b18afab5541e2e75c5504943">SCSI_ASENSE_NO_ADDITIONAL_INFORMATION</a>,</div>
<div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div>
<div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160; }</div>
<div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;</div>
<div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160; <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;}</div>
<div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div>
<div class="line"><a name="l00170"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#a0137191ee92c01b7ae7f2b63739b27c7">  170</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#a0137191ee92c01b7ae7f2b63739b27c7">SCSI_Command_Inquiry</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;{</div>
<div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160; uint16_t AllocationLength  = <a class="code" href="group___group___byte_swapping.html#ga0ade1c82bee6691c7de066bdc46e0b1f">SwapEndian_16</a>(*(uint16_t *) &amp;MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[3]);</div>
<div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160; uint16_t BytesTransferred  = <a class="code" href="group___l_p_c___types___public___macros.html#ga3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(AllocationLength, <span class="keyword">sizeof</span>(<a class="code" href="_s_c_s_i_8c.html#ae813fbf7ac35aa107d8f3e79fa5a283b">InquiryData</a>));</div>
<div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;</div>
<div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160; <span class="comment">/* Only the standard INQUIRY data is supported, check if any optional INQUIRY bits set */</span></div>
<div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160; <span class="keywordflow">if</span> ((MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[1] &amp; ((1 &lt;&lt; 0) | (1 &lt;&lt; 1))) ||</div>
<div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;  MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[2]) {</div>
<div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  <span class="comment">/* Optional but unsupported bits set - update the SENSE key and fail the request */</span></div>
<div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga9b67f1f2b889dec9c96b56f7f6e0437d">SCSI_SENSE_KEY_ILLEGAL_REQUEST</a>,</div>
<div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga35b49f8f4f191735ad5c3d642a6c367b">SCSI_ASENSE_INVALID_FIELD_IN_CDB</a>,</div>
<div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div>
<div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160; }</div>
<div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div>
<div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#gaa7d50585814f26359e7e03f06dcf1546" title="Writes the given number of bytes to the endpoint from the given buffer in little endian, sending full packets to the host as needed. The last packet filled is not automatically sent; the user is responsible for manually sending the last written packet to the host via the Endpoint_ClearIN() macro.">Endpoint_Write_Stream_LE</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, &amp;<a class="code" href="_s_c_s_i_8c.html#ae813fbf7ac35aa107d8f3e79fa5a283b">InquiryData</a>, BytesTransferred, <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div>
<div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160; <span class="comment">/* Pad out remaining bytes with 0x00 */</span></div>
<div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#ga3fd2f6732c97c91097516db8310101ea" title="Writes a given number of zeroed bytes to the currently selected endpoint&#39;s bank, sending full packets...">Endpoint_Null_Stream</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, (AllocationLength - BytesTransferred), <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div>
<div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160; <span class="comment">/* Finalize the stream transfer to send the last packet */</span></div>
<div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160; <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#gac77a265248435e56ce43ee2a488cf914">Endpoint_ClearIN</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>);</div>
<div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div>
<div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160; <span class="comment">/* Succeed the command and update the bytes transferred counter */</span></div>
<div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength -= BytesTransferred;</div>
<div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div>
<div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;}</div>
<div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div>
<div class="line"><a name="l00203"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#a26123dc4d7ffdd6f60ce7cc9f5b4392f">  203</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#a26123dc4d7ffdd6f60ce7cc9f5b4392f">SCSI_Command_Request_Sense</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;{</div>
<div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160; uint8_t  AllocationLength = MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[4];</div>
<div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160; uint8_t  BytesTransferred = <a class="code" href="group___l_p_c___types___public___macros.html#ga3acffbd305ee72dcd4593c0d8af64a4f">MIN</a>(AllocationLength, <span class="keyword">sizeof</span>(<a class="code" href="_s_c_s_i_8c.html#aae378701a4160a515783b3a5e21c437e">SenseData</a>));</div>
<div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div>
<div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#gaa7d50585814f26359e7e03f06dcf1546" title="Writes the given number of bytes to the endpoint from the given buffer in little endian, sending full packets to the host as needed. The last packet filled is not automatically sent; the user is responsible for manually sending the last written packet to the host via the Endpoint_ClearIN() macro.">Endpoint_Write_Stream_LE</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, &amp;<a class="code" href="_s_c_s_i_8c.html#aae378701a4160a515783b3a5e21c437e">SenseData</a>, BytesTransferred, <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#ga3fd2f6732c97c91097516db8310101ea" title="Writes a given number of zeroed bytes to the currently selected endpoint&#39;s bank, sending full packets...">Endpoint_Null_Stream</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, (AllocationLength - BytesTransferred), <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160; <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#gac77a265248435e56ce43ee2a488cf914">Endpoint_ClearIN</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>);</div>
<div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div>
<div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160; <span class="comment">/* Succeed the command and update the bytes transferred counter */</span></div>
<div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength -= BytesTransferred;</div>
<div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;</div>
<div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;}</div>
<div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div>
<div class="line"><a name="l00221"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#a0b33262f1bc3886722196d9a8d87efcb">  221</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#a0b33262f1bc3886722196d9a8d87efcb">SCSI_Command_Read_Capacity_10</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;{</div>
<div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;<span class="preprocessor">#ifdef CFG_SDCARD</span></div>
<div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;<span class="preprocessor"></span> <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> LastBlockAddressInLUN = MSC_Get_Block_Count() - 1;</div>
<div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;<span class="preprocessor"></span> <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> LastBlockAddressInLUN = (<a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga74ba398e7640ffa25cfd45e346ba7c17">LUN_MEDIA_BLOCKS</a> - 1);</div>
<div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="preprocessor"></span> <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> MediaBlockSize        = <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga46b701cd2078c2091bd4678e38ce8e64">VIRTUAL_MEMORY_BLOCK_SIZE</a>;</div>
<div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;</div>
<div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#ga12288e987a0e23dfa770fa59ecc74203" title="Writes the given number of bytes to the endpoint from the given buffer in big endian, sending full packets to the host as needed. The last packet filled is not automatically sent; the user is responsible for manually sending the last written packet to the host via the Endpoint_ClearIN() macro.">Endpoint_Write_Stream_BE</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>,</div>
<div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;        &amp;LastBlockAddressInLUN,</div>
<div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;        <span class="keyword">sizeof</span>(LastBlockAddressInLUN),</div>
<div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;        <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160; <a class="code" href="group___group___endpoint_stream_r_w.html#ga12288e987a0e23dfa770fa59ecc74203" title="Writes the given number of bytes to the endpoint from the given buffer in big endian, sending full packets to the host as needed. The last packet filled is not automatically sent; the user is responsible for manually sending the last written packet to the host via the Endpoint_ClearIN() macro.">Endpoint_Write_Stream_BE</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, &amp;MediaBlockSize, <span class="keyword">sizeof</span>(MediaBlockSize), <a class="code" href="group___l_p_c___types___public___macros.html#ga070d2ce7b6bb7e5c05602aa8c308d0c4">NULL</a>);</div>
<div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160; <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#gac77a265248435e56ce43ee2a488cf914">Endpoint_ClearIN</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>);</div>
<div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div>
<div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160; <span class="comment">/* Succeed the command and update the bytes transferred counter */</span></div>
<div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength -= 8;</div>
<div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;</div>
<div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;}</div>
<div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div>
<div class="line"><a name="l00248"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#adc91b127f1dc8952de57a7cf46bb129f">  248</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#adc91b127f1dc8952de57a7cf46bb129f">SCSI_Command_Send_Diagnostic</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;{</div>
<div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160; <span class="comment">/* Check to see if the SELF TEST bit is not set */</span></div>
<div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160; <span class="keywordflow">if</span> (!(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[1] &amp; (1 &lt;&lt; 2))) {</div>
<div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  <span class="comment">/* Only self-test supported - update SENSE key and fail the command */</span></div>
<div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga9b67f1f2b889dec9c96b56f7f6e0437d">SCSI_SENSE_KEY_ILLEGAL_REQUEST</a>,</div>
<div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga35b49f8f4f191735ad5c3d642a6c367b">SCSI_ASENSE_INVALID_FIELD_IN_CDB</a>,</div>
<div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div>
<div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160; }</div>
<div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160; <span class="comment">/* Succeed the command and update the bytes transferred counter */</span></div>
<div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength = 0;</div>
<div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div>
<div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;}</div>
<div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div>
<div class="line"><a name="l00269"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#af6f83e66195f7956862be0cd00dca196">  269</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#af6f83e66195f7956862be0cd00dca196">SCSI_Command_ReadWrite_10</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo,</div>
<div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;           <span class="keyword">const</span> <span class="keywordtype">bool</span> IsDataRead)</div>
<div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;{</div>
<div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160; <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> <a class="code" href="_dataflash_manager_8h.html#a65316bf93f8f5824a53d8bdd0080b8fb">BlockAddress</a>;</div>
<div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160; uint16_t <a class="code" href="_dataflash_manager_8h.html#a178c3b4a0fc190e877fb7a9973584faf">TotalBlocks</a>;</div>
<div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div>
<div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160; <span class="comment">/* Check if the disk is write protected or not */</span></div>
<div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160; <span class="keywordflow">if</span> ((IsDataRead == <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga1033012652c8143c410c1b30f1dc5af0">DATA_WRITE</a>) &amp;&amp; <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga8bbf5d8cbc2b7f0f5e0ac0d200cf234a">DISK_READ_ONLY</a>) {</div>
<div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;  <span class="comment">/* Block address is invalid, update SENSE key and return command fail */</span></div>
<div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga57aebfcc4b95d0b099f1b8e6dbc92910">SCSI_SENSE_KEY_DATA_PROTECT</a>,</div>
<div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga569fc903fbeb1166e31da2abfdbb834b">SCSI_ASENSE_WRITE_PROTECTED</a>,</div>
<div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div>
<div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160; }</div>
<div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div>
<div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160; <span class="comment">/* Load in the 32-bit block address (SCSI uses big-endian, so have to reverse the byte order) */</span></div>
<div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160; BlockAddress =</div>
<div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;  (MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[2] &lt;&lt;</div>
<div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;   24) + (MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[3] &lt;&lt; 16) +</div>
<div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;  (MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[4] &lt;&lt;</div>
<div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;   8) + MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[5];</div>
<div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div>
<div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160; <span class="comment">/* Load in the 16-bit total blocks (SCSI uses big-endian, so have to reverse the byte order) */</span></div>
<div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160; TotalBlocks  =</div>
<div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;  (MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[7] &lt;&lt;</div>
<div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;   8) + MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.SCSICommandData[8];</div>
<div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div>
<div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160; <span class="comment">/* Check if the block address is outside the maximum allowable value for the LUN */</span></div>
<div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div>
<div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;<span class="preprocessor">#ifdef CFG_SDCARD</span></div>
<div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;<span class="preprocessor"></span> <span class="keywordflow">if</span> (BlockAddress &gt;= MSC_Get_Block_Count())</div>
<div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;#<span class="keywordflow">else</span></div>
<div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160; <span class="keywordflow">if</span> (BlockAddress &gt;= <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga74ba398e7640ffa25cfd45e346ba7c17">LUN_MEDIA_BLOCKS</a>)</div>
<div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="preprocessor"></span> {</div>
<div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  <span class="comment">/* Block address is invalid, update SENSE key and return command fail */</span></div>
<div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;  <a class="code" href="group___mass___storage___device___s_c_s_i.html#ga89b450bcd29ca2f542ed59d3ceab5aeb">SCSI_SET_SENSE</a>(<a class="code" href="group___group___u_s_b_class_m_s_common.html#ga9b67f1f2b889dec9c96b56f7f6e0437d">SCSI_SENSE_KEY_ILLEGAL_REQUEST</a>,</div>
<div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga1cdc68941eb6ba80b3365108e1ab16b3">SCSI_ASENSE_LOGICAL_BLOCK_ADDRESS_OUT_OF_RANGE</a>,</div>
<div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;        <a class="code" href="group___group___u_s_b_class_m_s_common.html#ga61a355514f367ad86c511563670ad276">SCSI_ASENSEQ_NO_QUALIFIER</a>);</div>
<div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;</div>
<div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160; }</div>
<div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div>
<div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;<span class="preprocessor"> #if (TOTAL_LUNS &gt; 1)</span></div>
<div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="preprocessor"></span> <span class="comment">/* Adjust the given block address to the real media address based on the selected LUN */</span></div>
<div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160; BlockAddress += ((<a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a>) MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.LUN * <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga74ba398e7640ffa25cfd45e346ba7c17">LUN_MEDIA_BLOCKS</a>);</div>
<div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="preprocessor"> #endif</span></div>
<div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="preprocessor"></span></div>
<div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="preprocessor">#ifdef CFG_SDCARD</span></div>
<div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;<span class="preprocessor"></span> <span class="comment">/* Determine if the packet is a READ (10) or WRITE (10) command, call appropriate function */</span></div>
<div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160; <span class="keywordflow">if</span> (IsDataRead == <a class="code" href="group___mass___storage___device___s_c_s_i.html#gab2f24d71b50144885a0f182b6d2e274a">DATA_READ</a>) {</div>
<div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;  <a class="code" href="group___s_d_m_m_c__17_x_x__40_x_x.html#gaa6ad043a27fea83ec852d2b75e3521fe" title="Performs the read of data from the SD/MMC card.">Chip_SDMMC_ReadBlocks</a>(<a class="code" href="group___p_e_r_i_p_h__18_x_x___b_a_s_e.html#ga0dad86ccae5b13170e0204ed651a2847">LPC_SDMMC</a>, (<span class="keywordtype">void</span> *) disk_cache, BlockAddress, TotalBlocks);</div>
<div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;  <span class="keywordflow">while</span> (!<a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#ga824fe54ec1f787c9e0409f42bcbe0622">Endpoint_IsINReady</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>)) {}</div>
<div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#ga031fd65a988efe29032f9abcdfb06d0d">Endpoint_Streaming</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>,</div>
<div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;         (uint8_t *) disk_cache,</div>
<div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;         <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga46b701cd2078c2091bd4678e38ce8e64">VIRTUAL_MEMORY_BLOCK_SIZE</a>,</div>
<div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;         TotalBlocks,</div>
<div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;         0);</div>
<div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160; }</div>
<div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160; <span class="keywordflow">else</span> {</div>
<div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;  <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#ga031fd65a988efe29032f9abcdfb06d0d">Endpoint_Streaming</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>,</div>
<div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;         (uint8_t *) disk_cache,</div>
<div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;         <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga46b701cd2078c2091bd4678e38ce8e64">VIRTUAL_MEMORY_BLOCK_SIZE</a>,</div>
<div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;         TotalBlocks,</div>
<div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;         0);</div>
<div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;  <span class="keywordflow">while</span> (!<a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#gaa39efa82c519bcf7fa411f11d907fd99">Endpoint_IsOUTReceived</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>)) {}</div>
<div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;  <a class="code" href="group___s_d_m_m_c__17_x_x__40_x_x.html#gacabddeaaef0cd5dd2c4535891b775e7e" title="Performs write of data to the SD/MMC card.">Chip_SDMMC_WriteBlocks</a>(<a class="code" href="group___p_e_r_i_p_h__18_x_x___b_a_s_e.html#ga0dad86ccae5b13170e0204ed651a2847">LPC_SDMMC</a>, (<span class="keywordtype">void</span> *) disk_cache, BlockAddress, TotalBlocks);</div>
<div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160; }</div>
<div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;<span class="preprocessor">#else</span></div>
<div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;<span class="preprocessor"></span> <a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a> startaddr;</div>
<div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160; uint16_t blocks, dummyblocks;</div>
<div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;</div>
<div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160; startaddr = <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga207ad2c904dcb3970c5ff29f68f7daac" title="DataRAM read blocks function.">MassStorage_GetAddressInImage</a>(BlockAddress, TotalBlocks, &amp;blocks);</div>
<div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160; <span class="keywordflow">if</span> (blocks == 0) {</div>
<div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;  dummyblocks = <a class="code" href="_dataflash_manager_8h.html#a178c3b4a0fc190e877fb7a9973584faf">TotalBlocks</a>;</div>
<div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160; }</div>
<div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160; <span class="keywordflow">else</span> <span class="keywordflow">if</span> (blocks &lt; TotalBlocks) {</div>
<div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;  dummyblocks = TotalBlocks - blocks;</div>
<div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160; }</div>
<div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160; <span class="keywordflow">else</span> {dummyblocks = 0; }</div>
<div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160; <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#ga031fd65a988efe29032f9abcdfb06d0d">Endpoint_Streaming</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>,</div>
<div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;        (uint8_t *) startaddr,</div>
<div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;        <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga46b701cd2078c2091bd4678e38ce8e64">VIRTUAL_MEMORY_BLOCK_SIZE</a>,</div>
<div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;        blocks,</div>
<div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;        dummyblocks);</div>
<div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160; <span class="keywordflow">while</span> (!<a class="code" href="group___group___endpoint_packet_management.html#ga17f6c1eb99c13e723cf168f40826a6e3" title="Determines if the currently selected endpoint may be read from (if data is waiting in the endpoint ba...">Endpoint_IsReadWriteAllowed</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>)) {}</div>
<div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;<span class="preprocessor"></span> <span class="comment">/* Update the bytes transferred counter and succeed the command */</span></div>
<div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength -= ((<a class="code" href="_e_h_c_i_8h.html#ad14d3f736deaab092d7bc0dcb1430bc8">uint32_t</a>) TotalBlocks * <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga46b701cd2078c2091bd4678e38ce8e64">VIRTUAL_MEMORY_BLOCK_SIZE</a>);</div>
<div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div>
<div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;}</div>
<div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div>
<div class="line"><a name="l00372"></a><span class="lineno"><a class="code" href="_s_c_s_i_8c.html#a03d4a35fdb5a2b73965af52a4ac59307">  372</a></span>&#160;<span class="keyword">static</span> <span class="keywordtype">bool</span> <a class="code" href="_s_c_s_i_8c.html#a03d4a35fdb5a2b73965af52a4ac59307">SCSI_Command_ModeSense_6</a>(<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html" title="Mass Storage Class Device Mode Configuration and State Structure.">USB_ClassInfo_MS_Device_t</a> *<span class="keyword">const</span> MSInterfaceInfo)</div>
<div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;{</div>
<div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160; <span class="comment">/* Send an empty header response with the Write Protect flag status */</span></div>
<div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160; <a class="code" href="group___group___endpoint_primitive_r_w.html#ga442e0512893cd22d07bc7f9f82649e77" title="Writes one byte to the currently selected endpoint&#39;s bank, for IN direction endpoints.">Endpoint_Write_8</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, 0x00);</div>
<div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160; <a class="code" href="group___group___endpoint_primitive_r_w.html#ga442e0512893cd22d07bc7f9f82649e77" title="Writes one byte to the currently selected endpoint&#39;s bank, for IN direction endpoints.">Endpoint_Write_8</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, 0x00);</div>
<div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160; <a class="code" href="group___group___endpoint_primitive_r_w.html#ga442e0512893cd22d07bc7f9f82649e77" title="Writes one byte to the currently selected endpoint&#39;s bank, for IN direction endpoints.">Endpoint_Write_8</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, <a class="code" href="group___e_x_a_m_p_l_e___d_u_a_l_c_o_r_e___mass_storage.html#ga8bbf5d8cbc2b7f0f5e0ac0d200cf234a">DISK_READ_ONLY</a> ? 0x80 : 0x00);</div>
<div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160; <a class="code" href="group___group___endpoint_primitive_r_w.html#ga442e0512893cd22d07bc7f9f82649e77" title="Writes one byte to the currently selected endpoint&#39;s bank, for IN direction endpoints.">Endpoint_Write_8</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>, 0x00);</div>
<div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160; <a class="code" href="group___group___endpoint_management___l_p_c11_uxx.html#gac77a265248435e56ce43ee2a488cf914">Endpoint_ClearIN</a>(MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#abc14d2c9d741299c132cd01078d6d2af">Config</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a7b1124453ea43f7e9569847aa322c83c">PortNumber</a>);</div>
<div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div>
<div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160; <span class="comment">/* Update the bytes transferred counter and succeed the command */</span></div>
<div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160; MSInterfaceInfo-&gt;<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a683a6b6590460c77fe15c4a2c995a29b">State</a>.<a class="code" href="struct_u_s_b___class_info___m_s___device__t.html#a8e8a77cbe2bac91f6acf20dc75d8aaf5">CommandBlock</a>.DataTransferLength -= 4;</div>
<div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;</div>
<div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160; <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_a6e4fee11f07c3b70486e88fe92cbbdc.html">applications</a></li><li class="navelem"><a class="el" href="dir_248eb81c9753f3edc8d52c14c639c196.html">LPCUSBlib</a></li><li class="navelem"><a class="el" href="dir_5bf910793894cd0095744dfc1b6a1b87.html">lpcusblib_MassStorageDevice</a></li><li class="navelem"><a class="el" href="dir_7f3023615611edfba1deb46126beb52c.html">Lib</a></li><li class="navelem"><a class="el" href="_s_c_s_i_8c.html">SCSI.c</a></li>
    <li class="footer">Generated on Fri May 10 2013 10:42:09 for LPCOpen Platform by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.2 </li>
  </ul>
</div>
</body>
</html>
